<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>휴직 관리</title>
	
	<!--공통 -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" th:href="@{/assets/css/bootstrap.css}">
	<link rel="stylesheet" th:href="@{/assets/vendors/iconly/bold.css}">
	<link rel="stylesheet" th:href="@{/assets/vendors/perfect-scrollbar/perfect-scrollbar.css}">
	<link rel="stylesheet" th:href="@{/assets/vendors/bootstrap-icons/bootstrap-icons.css}">
	<link rel="stylesheet" th:href="@{/assets/css/app.css}">
	<link rel="shortcut icon" th:href="@{/assets/images/favicon.svg}" th:type="@{/assets/image/x-icon}">

	<!-- TOAST UI CDN -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	<style>
		.tui-grid-cell {
			/* !important -> 우선순위 높아짐 */
			background-color: #ffffff !important;
		}
		.display-flex {
			display: flex;
			
		}
		.buttons { /* 페이지명과 같은 위치에서 버튼을 오른쪽에 두기 위함 */
			margin-left:auto
		}
		.child-input1 {
		    flex:1;
		    width:30%;
		    box-sizing: border-box;
		}

		.child-input2{
		    flex:1;
		    margin: 0px 5%;
		    width:30%;
		    box-sizing: border-box;
		}
	</style>
</head>
<body>
		
	<div id="app">
		
		<!-- 사이드 메뉴바-->
		<div th:replace="~{fragments/sidebar :: sidebar}"></div>
		
		<!-- 메인 content -->
		<div id="main">
			
			<!-- 반응형 사이드 메뉴 버튼-->
			<header class="mb-3">
		        <a href="#" class="burger-btn d-block d-xl-none">
		            <i class="bi bi-justify fs-3"></i>
		        </a>
		    </header>
			
			<div class="display-flex">
				<h3>휴직 관리</h3>
				
				<div class="buttons">
			 	<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loab-request">휴직 신청</button>
				
				<!-- 휴직 신청서 Modal 시작 -->
				<div class="modal fade text-left" id="loab-request" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
					
					<div class="modal-dialog modal-dialog-scrollable" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title" id="myModalLabel33">휴직 신청서</h4>
								<button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
									<i data-feather="x"></i>
								</button>
							</div>
							<form th:action="@{/loab-insert}" method="post">
								<div class="modal-body">
									<!-- placeholder=사용자가 값을 입력하기 전에 입력값에 도움을 줄 수 있는 짧은 힌트를 입력 상자에 표시 -->
									
									<div class="display-flex">
										<div class="child-input1">
											<label>사번: </label>
											<div class="form-group">
												<input type="text" value="11222" name="emp_id" class="form-control" readonly >
											</div>
										</div>
										<div class="child-input2">
											<label>이름: </label>
											<div class="form-group">
												<input type="text" value="홍길동" class="form-control" readonly>
											</div>
										</div>
									</div>
					
									<div class="display-flex">
										<div class="child-input1">
											<label>사용 시작일: </label>
											<div class="form-group">
												<input type="date" class="form-control" id="use-start-date" onchange="calcDate()" name="absence_start">
											</div>
										</div>
										<div class="child-input2">
											<label>사용 종료일: </label>
											<div class="form-group">
												<input type="date" class="form-control" id="use-end-date" onchange="calcDate()" name="absence_end">
											</div>
										</div>
									</div>
									
									<div class="display-flex">
										<div class="child-input1">
											<label>사용일수: </label>
											<div class="form-group">
												<input type="text" id="use-days" class="form-control" readonly>
											</div>
										</div>
										
										<div class="child-input2">
											<label>휴직 구분</label>
											<fieldset class="form-group">
												<select class="form-select" id="loabSelect" name="absence_type">
													<option value="" disabled selected>선택하세요</option>
												</select>
											</fieldset>
										</div>
									</div>
									
									<div class="display-flex">
										<div class="child-input1">
											<label>비고사항 </label>
											<div class="form-group">
												<textarea id="remark"class="form-control" name="absence_remark"></textarea>
											</div>
										</div>
									</div>
									<div class="display-flex">
										<div class="child-input1">
											<label>승인 요청 선택 </label>
											<fieldset class="form-group">
												<select class="form-select" id="requestSelect" name="request_approval" >
													<option value="" disabled selected>선택하세요</option>
												</select>
											</fieldset>
										</div>
										<div class="child-input2">
											<label>요청 기한</label>
											<div class="form-group">
												<input type="date" class="form-control" id="date_deadline" onchange="calcDate2()">
											</div>
										</div>
									</div>
									<input type="hidden" id="requestRole" name="request_role">
									<input type="hidden" id="deadline" name="request_deadline">
								</div><!-- modal body -->
								<div class="modal-footer">
									<button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
										<i class="bx bx-x d-block d-sm-none"></i>
										<span class="d-none d-sm-block">닫기</span>
									</button>
									<button type="submit" class="btn btn-primary ml-1" >
										<i class="bx bx-check d-block d-sm-none"></i>
										<span class="d-none d-sm-block">신청</span>
									</button>
								</div>
							</form> <!-- 휴직 신청서 모달폼 끝 -->
						</div>
					</div>
				</div>
				<!-- 휴가 신청서 Modal 끝 -->
		  </div> <!-- buttons -->
		</div> <!-- display-flex -->

		<div class="card">
			<div class="card-body">

				<!-- 그리드 시작 -->
				<section class="section">
					<div class="row" id="basic-table">
						<form>
							<div id="grid"></div>
							<div class="float-end">
								<input type="button" class="btn btn-outline-secondary" id="appendRow" value="추가">
								<input type="button" class="btn btn-outline-success" id="save"  value="저장">
								<input type="button" class="btn btn-outline-danger" id="delete" value="삭제">
							</div>
						</form>
					</div>
				</section>
				<!-- 그리드 끝  -->
				
			</div><!-- card-body --> 
		</div> <!-- card --> 
	
		</div><!--main--> 
	</div><!-- app -->
	
	<!-- 모달 정의 -->
	<div class="modal fade" id="empSerchModal" tabindex="-1" aria-labelledby="empSerchModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="empSerchModalLabel">사원 조회</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body" id="empSerchModalBody">
	                <!-- 동적 컨텐츠 -->
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	                <button type="button" class="btn btn-primary" id="modalConfirmButton">확인</button>
	            </div>
	        </div>
	    </div>
	</div>
	
	
		
		
	<!-- 제이쿼리 -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>	
	
	<!--Axios -->
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	
	<!-- sweet arert -->
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	
	<!--공통 -->
	<script th:src="@{/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/js/main.js}"></script>

	<!-- TOAST UI CDN -->
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	
	<script th:inline="javascript">
	
		let grid;
		
		const gridData = /*[[${absenceList}]]*/'';
		
		// 모달창 휴직 구분 공통코드 불러오기
		$('#loabSelect').on('click', function () {
		    // 이미 데이터가 로드된 경우 추가 요청 방지
		    if (this.options.length > 1) {
		        return;
		    }

		    const type = 'LOAB'; 

		    getCommonList(type).then(function (data) {
		        $('#loabSelect')
		            .empty()
		            .append('<option value="" disabled selected>선택하세요</option>');

		        data.forEach(item => {
		            if (item.common_detail_code && item.common_detail_name) {
		                $('#loabSelect').append(
		                    $('<option></option>').val(item.common_detail_code).text(item.common_detail_name)
		                );
		            }
		        });
		    });
		});
		
		// 모달창 승인 대상자 리스트 불러오기
		$('#requestSelect').on('click', function () {
		    // 이미 데이터가 로드된 경우 추가 요청 방지
		    if (this.options.length > 1) {
		        return;
		    }
			
			// *** 현재 권한자가 LOW면 MIDDLE, 현재 권한자가 MIDDLE 이면 HIGH 조건문 추가 필요****
			const role = 'MIDDLE';

			axios.get(`/api/absence/request/${role}`)
	        .then(function (response) {
	            const data = response.data;
	            data.forEach(item => {
	                console.log(item); // 각 아이템 확인
	            });

	            $('#requestSelect').empty().append('<option value="" disabled selected>선택하세요</option>');
				
	            data.forEach(item => {
	                $('#requestSelect').append(
	                    $('<option></option>').val(item.EMP_ID).text(item.EMP_NAME + " / " + item.EMP_DEPT_NAME + " / " + item.EMP_POSITION_NAME)
	                );
	                
	                $('#requestRole').val(item.EMP_ROLE);
	                
	            });
	        })
	        .catch(function (error) {
	            console.error('Error:', error);
	            alert('데이터를 가져오는 중 문제가 발생했습니다.');
	        });
			
		});
		
		
		// type으로 공통 코드 가져오는 함수
		function getCommonList(type) {
		    return axios.get(`/api/absence/common/list/${type}`)
		        .then(function (response) {
		            return response.data; // 데이터 반환
		        })
		        .catch(function (error) {
		            console.error('Error fetching data:', error);
		            alert('데이터를 가져오는 중 문제가 발생했습니다.');
		            return []; // 에러 발생 시 빈 배열 반환
		        });
		}
		
		// 그리드 초기화
		fetchData().then(function (data) {
			
		    grid = new tui.Grid({
		    	el: document.getElementById('grid'),
				data: gridData,
				rowHeaders: ['checkbox'],
				columns: [
					{
						header: '번호', 
						name: 'ABSENCE_NO', 
						filter: { type: 'text', showApplyBtn: true, showClearBtn: true },
						editor: 'text'
					},
					{ 
						header: '사원번호', 
						name: 'EMP_ID', 
						filter: { type: 'text', showApplyBtn: true, showClearBtn: true },
						editor: 'text'
					},  
					{ 
						header: '사원명', 
						name: 'EMP_NAME', 
						filter: { type: 'text', showApplyBtn: true, showClearBtn: true },
						editor: 'text'
					},
					{ 
						header: '부서', 
						name: 'EMP_DEPT',
						editor: {
							type: 'select',
							options: {
								listItems: data.deptCommon
							}
					    },
						filter: 'select'
					},
					{ 
						header: '직급', 
						name: 'EMP_POSITION', 
						editor: {
							type: 'select',
							options: {
								listItems: data.pstnCommon
							}
					    },
						filter: 'select'
					},
					{ 
						header: '종류', 
						name: 'COMMON_DETAIL_NAME',
						editor: {
							type: 'select',
							options: {
								listItems: data.loabCommon
							}
					    },
						filter: 'select'
					},
					
					{ 
						header: '휴직 시작일', 
						name: 'ABSENCE_START',
						editor: {
			                type: 'datePicker',
			                options: {
			                    format: 'yyyy-MM-dd'
			                }
			            },
			            filter: {
			                type: 'date',
			                options: {
			                    format: 'yyyy-MM-dd'
			                }
			            }
			        },
			        { 
						header: '휴직 종료일', 
						name: 'ABSENCE_END',
						editor: {
			                type: 'datePicker',
			                options: {
			                    format: 'yyyy-MM-dd'
			                }
			            },
			            filter: {
			                type: 'date',
			                options: {
			                    format: 'yyyy-MM-dd'
			                }
			            }
			        },
			        { 
						header: '신청일', 
						name: 'REQUEST_DATE',
						editor: {
			                type: 'datePicker',
			                options: {
			                    format: 'yyyy-MM-dd'
			                }
			            },
			            filter: {
			                type: 'date',
			                options: {
			                    format: 'yyyy-MM-dd'
			                }
			            }
			        },
			        { 
						header: '최종 승인자', 
						name: 'HIGH_APPROVAL', 
						filter: { type: 'text', showApplyBtn: true, showClearBtn: true },
						editor: 'text'
					},
					{ 
						header: '비고', 
						name: 'ABSENCE_REMARK',
						editor: 'text'
					}
				],
				editing: true  // 편집 기능 활성화
				
			});
		    
		    
		 // 사원번호/사원명 수정 시 모달창에서 사원 조회 후 등록
		    grid.on('editingStart', function (ev) {
		    	const { rowKey, columnName } = ev;

		        // 사원번호 또는 사원명 수정 시 모달 띄우기
		        if (columnName === 'EMP_ID' || columnName === 'EMP_NAME') {
		            ev.stop(); // 기본 편집 동작 중단
		            
		        	// 해당 행의 데이터 가져오기
		            const rowData = grid.getRow(rowKey);

		            // 사원번호와 사원명을 함께 전달
		            showEmpModal(rowKey, columnName, rowData.EMP_ID, rowData.EMP_NAME);
		        }
		        
		    });
		 
		 
			
		});
		
		
		// 사원 조회 모달창 표시 함수 
		function showEmpModal(rowKey, columnName, empId, empName) {
			
		    const $modal = $('#empSerchModal');
		    const $modalTitle = $('#empSerchModalLabel');
		    const $modalBody = $('#empSerchModalBody');

		    // 모달 내용 업데이트
		    $modalBody.html(`
		        <form>
		            <div class="form-group">
		               
		                <div class="display-flex">
						<div class="child-input1">
							<label>사번: </label>
							<div class="form-group">
								<input type="text" value="${empId || ''}" name="emp_id" class="form-control emp-serch">
							</div>
						</div>
						<div class="child-input2">
							<label>이름: </label>
							<div class="form-group">
								<input type="text" value="${empName || ''}" class="form-control emp-serch" >
							</div>
						</div>
					</div>
		            </div>
		        </form>
		    `);

		    // 모달 표시
		    $modal.modal('show');

			 // 확인 버튼 클릭 시 이벤트 처리
		    $('#modalConfirmButton').off('click').on('click', function () {
		        // 모달에서 입력된 값을 가져오기
		        const newEmpId = $('input[name="emp_id"]').val();
		        const newEmpName = $('input[name="emp_name"]').val();

		        // 그리드 데이터 업데이트
		        if (columnName === 'EMP_ID') {
		            grid.setValue(rowKey, 'EMP_ID', newEmpId);
		        } else if (columnName === 'EMP_NAME') {
		            grid.setValue(rowKey, 'EMP_NAME', newEmpName);
		        }
		        
		        // 모달 닫기
		        $modal.modal('hide');
		    });
		}
		
				
		
		// 그리드 수정 시 공통코드 셀렉트값 가져오기
		function fetchData() {
		    
		    return Promise.all([
		    	 getCommonList('DEPT'),  // 부서 
		         getCommonList('PSTN'),   // 직급
		         getCommonList('LOAB') // 휴직 
		        
		        
		    ])
		    .then(function ([deptCommon, pstnCommon, loabCommon]) {
		        return {
		        	deptCommon: deptCommon.map(item => ({
		                text: item.common_detail_name,
		                value: item.common_detail_name
		            })),
		            pstnCommon: pstnCommon.map(item => ({
		                text: item.common_detail_name,
		                value: item.common_detail_name
		            })),
		            loabCommon: loabCommon.map(item => ({
		                text: item.common_detail_name,
		                value: item.common_detail_name
		            }))
		        };
		    })
		    .catch(function (error) {
		        console.error('Error fetching data:', error);
		        return { deptCommon: [], pstnCommon: [], loabCommon: [] };
		    });
		}
		
		
		// "추가" 버튼 클릭 이벤트
		$('#appendRow').on('click', function (e) {
			e.preventDefault(); // 기본 동작 방지
			
			// 기본값으로 새 행 데이터 생성
			const newRow = {
				ABSENCE_NO: grid.getRowCount() + 1,
				EMP_ID: '',
				EMP_NAME: '',
				EMP_DEPT: '', 
				EMP_POSITION: '', 
				ABSENCE_TYPE: '', 
				ABSENCE_START: '',
				ABSENCE_END: '',
				REQUEST_DATE: '',
				HIGH_APPROVAL: ''
			};
			
			// 새 행을 TOAST UI Grid에 추가
			grid.appendRow(newRow, {
				focus: true // 추가된 행에 포커스
			});
		});
		
		
		
		// "저장" 버튼 클릭 이벤트
		$('#save').on('click', function () {
			
			const modifiedRows = grid.getModifiedRows();
			console.log(modifiedRows); 
// 			sendToServer(modifiedRows);
		});
		/*
		function sendToServer(data) {
			fetch('/update-data', {
				method: 'POST',
				headers: {
				  'Content-Type': 'application/json',
				},
				body: JSON.stringify(data),
			})
			.then(response => response.json())
			.then(result => {
				console.log('Server response:', result);
			})
			.catch(error => console.error('Error:', error));
		}
		*/
		
		
		
		
	</script>
	
	<!-- Modal 내에 있는 일수 계산 스크립트 -->
	<script>
		function calcDate() {
			// 사용 시작일과 종료일 가져오기
			const startDateValue = $('#use-start-date').val(); // yyyy-mm-dd 형식
			const endDateValue = $('#use-end-date').val();

			const startDate = new Date(startDateValue);
			const endDate = new Date(endDateValue);


			let count = 0; //일수
			
			if (startDateValue && endDateValue) {

				while (true) {
					const temp_date = startDate; //임시 날짜 변수에 시작일을 할당
					
					if (temp_date.getTime() > endDate.getTime()) {
						break;

					} else {
						const dateDay = temp_date.getDay(); //요일 구하는 변수
						if (dateDay !== 0 && dateDay !== 6) { // 0: 일요일, 6: 토요일
							//평일인 경우에만 count 증가
							count++;
						}
						temp_date.setDate(startDate.getDate() + 1); //다음 날로 이동
					}
				}
				$('#use-days').val(count);
			}
		}
		
		
		function calcDate2() {
			// 사용 시작일과 종료일 가져오기
			const today = new Date();
			const yyyy = today.getFullYear();
			const mm = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
			const dd = String(today.getDate()).padStart(2, '0');
			
			const startDateValue = `${yyyy}-${mm}-${dd}`; // yyyy-mm-dd 형식
			const endDateValue = $('#date_deadline').val();

			const startDate = new Date(startDateValue);
		    const endDate = new Date(endDateValue);

		    if (startDateValue && endDateValue) {
		        // 두 날짜의 차이를 밀리초 단위로 계산
		        const timeDifference = endDate.getTime() - startDate.getTime();

		        // 밀리초를 일(day) 단위로 변환
		        const dayDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

		        // 결과를 hidden에 저장
		        $('#deadline').val(dayDifference);
		    }
		    
		    
		}
		
		
	</script>


</body>

</html>
