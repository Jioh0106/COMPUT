<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COMPUT.</title>

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/bootstrap.css">
	
	<link rel="stylesheet" href="assets/vendors/iconly/bold.css">
	
	<link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
	<link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
	<link rel="stylesheet" href="assets/css/app.css">
	<link rel="icon" href="images/favicon.png" type="images/png">
	
	<!-- TOAST UI CDN -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	
	<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
	<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />

<style>
.tui-grid-cell {
	/* !important -> ìš°ì„ ìˆœìœ„ ë†’ì•„ì§ */
	background-color: #ffffff !important;
}

.display-flex {
	display: flex;
}

.buttons {
	/* í˜ì´ì§€ëª…ê³¼ ê°™ì€ ìœ„ì¹˜ì—ì„œ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ì— ë‘ê¸° ìœ„í•¨ */
	margin-left: auto
}

.buySelect {
	width: 150px !important;
}

.row mb-4{
	display: flex; 
	align-items: center
}

.buyDiv{
	display: flex; 
	align-items: center; 
	max-width: 230px; 
	flex-shrink: 0
}

.nameDiv{
	display: flex; 
	align-items: center; 
	max-width: 400px; 
	flex-shrink: 0;
}



</style>

</head>

<body>

	<div id="app">

		<!-- ì‚¬ì´ë“œ ë©”ë‰´ë°”-->
		<div th:replace="~{fragments/sidebar :: sidebar}"></div>

		<!-- ë©”ì¸ content -->
		<div id="main">


			<div class="display-flex">
				<h3>BOM ì •ë³´</h3>
			</div>
			<!-- display-flex -->

			<div class="card">
				<div class="card-body" id="default">
					
					<!-- ê·¸ë¦¬ë“œ ì‹œì‘ -->
					<section class="section">
						<div class="row" id="basic-table">
							<form>
								
								<!-- ê²€ìƒ‰ ì¡°ê±´ ì‹œì‘ -->
								<div class="row mb-4 align-items-center">
								    <!-- ìƒí’ˆë“±ë¡ì›”-->
								    <div class="col-md-4">
								       <label for="searchMonth" class="form-label">ë“±ë¡ì›”</label>
								       <input type="month" id="searchMonth" class="form-control" onchange="updateProductGrid()">
								    </div>
								    <!-- ìƒí’ˆëª… -->
									<div class="col-md-4">
										<label for="nameSearch" class="form-label">ìƒí’ˆëª…</label>
										<div class="input-group mb-3">
											<span class="input-group-text" id="basic-addon1"><i class="bi bi-search"></i></span>
											<input type="text" class="form-control" id="productName" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." aria-label="Recipient's username"
												aria-describedby="button-addon2" onkeyup="updateProductGrid()">
										</div>
									</div>
								</div>
								<!-- ê²€ìƒ‰ ì¡°ê±´ ë-->
								
								<div class="float-end mb-3">
								<input type="button" class="btn btn-outline-secondary" id="product" value="ìƒí’ˆë“±ë¡" onclick="openProductModal()">
								</div>
								<h4>ìƒí’ˆ</h4>
								<!--ìƒí’ˆê·¸ë¦¬ë“œ-->										   
								<div id="productGrid" class="mb-3 mt-2"></div>
								<h4>BOM</h4>
								<!--BOMê·¸ë¦¬ë“œ-->
								<div id="bomGrid" class="mb-3 mt-2"></div>
								
								<!-- ë²„íŠ¼ ì‹œì‘ -->
								<!--<div sec:authorize="hasRole('ATHR001') or hasRole('ATHR002')">-->
									<div class="float-end">
										<input type="button" class="btn btn-outline-secondary" id="bom" value="bomì°¾ê¸°" onclick="popUp()">
										<input type="button" class="btn btn-outline-success" id="save"  value="ì €ì¥" onclick=" updateBom()">
										<input type="button" class="btn btn-outline-danger" id="del" value="ì‚­ì œ" onclick="deleteSelectedRows()">
									</div>
								<!--</div>-->
								<!-- ë²„íŠ¼ ë -->
								
							</form>
						</div>
					</section>
					<!-- ê·¸ë¦¬ë“œ ë  -->

				</div> <!-- card-body -->
			</div> <!-- card -->
			
			
			<!--ìƒí’ˆë“±ë¡ ëª¨ë‹¬ ì‹œì‘ -->
	          <div class="me-1 mb-1 d-inline-block">
	              <!--Default size Modal -->
	              <div class="modal fade text-left" id="productModal" tabindex="-1"
	                  role="dialog" aria-labelledby="myModalLabel18" aria-hidden="true">
	                  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"
	                      role="document">
	                      <div class="modal-content">
	                          <div class="modal-header">
	                              <h4 class="modal-title" id="myModalLabel18">ìƒí’ˆë“±ë¡</h4>
	                              <button type="button" class="close" data-bs-dismiss="modal"
	                                  aria-label="Close">
	                                  <i data-feather="x"></i>
	                              </button>
	                          </div>
	                          <div class="modal-body">
								
								<label for="first-name-column">ìƒí’ˆëª…</label>
								<input type="text" id="proName" name="product_name" class="form-control">
								
								<label for="first-name-column">ë‹¨ìœ„</label>
								<select id="proUnit" class="form-control" name="product_unit">
									<option>ë‹¨ìœ„ ì„ íƒ</option>
									<option value="ê°œ">ê°œ</option>
								</select>
								
								
								<label for="first-name-column">ìƒí’ˆìœ í˜•</label>
								<select id="proType" class="form-control" name="product_type">
									<option>ìƒí’ˆìœ í˜•</option>
									<option value="ì™„ì œí’ˆ">ì™„ì œí’ˆ</option>
									<option value="ë°˜ì œí’ˆ">ë°˜ì œí’ˆ</option>
								</select>
								
	                          </div>
	                          <div class="modal-footer">
	                              <button type="button" class="btn btn-light-secondary"
	                                  data-bs-dismiss="modal">
	                                  <i class="bx bx-x d-block d-sm-none"></i>
	                                  <span class="d-none d-sm-block">ì·¨ì†Œ</span>
	                              </button>
	                              <button type="button" class="btn btn-primary ml-1" id="registBtn">
	                                  <i class="bx bx-check d-block d-sm-none"></i>
	                                  <span class="d-none d-sm-block">ë“±ë¡</span>
	                              </button>
	                          </div>
	                      </div>
	                  </div>
	              </div>
	          </div>
	          <!--ìƒí’ˆë“±ë¡ ëª¨ë‹¬ ë -->
	
		</div> <!-- main -->
	</div> <!-- app -->

	<!-- ì œì´ì¿¼ë¦¬ -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<script th:src="@{/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/js/main.js}"></script>

	<!-- TOAST UI CDN -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.js"></script>
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	
	<script th:inline="javascript">

		const header = document.querySelector('meta[name="_csrf_header"]').content;
		const token = document.querySelector('meta[name="_csrf"]').content;

	 	var Grid = tui.Grid;
		
		
			
		let processOptions = [];
		let unitOptions = [];
		let unitMap = {};// ê³µí†µì½”ë“œ â†’ ë‹¨ìœ„ëª… ë§¤í•‘ ê°ì²´
				
				
		
		const productGrid = new Grid({
				el: document.getElementById('productGrid'),
				rowHeaders: ['checkbox'],
				columns: [
					{header: 'ìƒí’ˆë²ˆí˜¸',	name: 'PRODUCT_NO', editor: 'text', sortable: true},
					{header: 'ìƒí’ˆìœ í˜•',	
					name: 'PRODUCT_TYPE', 
					editor: {
						type: 'select',
		                options: {
		                    listItems: [
		                        { value: 'ì™„ì œí’ˆ', text: 'ì™„ì œí’ˆ' },  
		                        { value: 'ë°˜ì œí’ˆ', text: 'ë°˜ì œí’ˆ' }
		                    ]
		                }
					}, 
					sortable: true},
					
					{header: 'ìƒí’ˆëª…',	name: 'PRODUCT_NAME', editor: 'text', sortable: true},
					
					{header: 'ë‹¨ìœ„',		
					name: 'PRODUCT_UNIT', 
					editor: {
			               type: 'select',
			               options: {
			                   listItems: unitOptions // ì „ì—­ë³€ìˆ˜
			               }
			           },
					formatter: ({ value }) => unitMap[value] || value, // ê³µí†µì½”ë“œ â†’ ë‹¨ìœ„ëª… ë³€í™˜   
					sortable: true, width: 100},
					
					{header: 'ë“±ë¡ì¼',	name: 'PRODUCT_DATE', editor: 'text', sortable: true}
				],
				data: [],
				columnOptions: {
				  resizable: true
				}
			});
		
	
		
		
		function loadProcessOptions() {
		    fetch('/api/product/select/process')
		        .then(response => response.json())
		        .then(data => {
					console.log(" ì„œë²„ì—ì„œ ë°›ì€ ê³µì •ìœ í˜• ë°ì´í„°:", data);
		            processOptions = data.map(item => ({
		                value: String(item.PROCESS_NO),  // ì €ì¥í•  ê³µì • ì½”ë“œ (ex: 1,2,3..)
		                text: item.PROCESS_NAME   // í™”ë©´ì— í‘œì‹œë  ê³µì •ëª… (ex: ê°€ê³µ)
		            	}));
						 // ê³µì • select ë°•ìŠ¤ì— ì¦‰ì‹œ ë°˜ì˜
			            bomGrid.getColumns().forEach(column => {
			                if (column.name === 'process_name' && column.editor) {
			                    column.editor.options.listItems = processOptions;
			                 }
			              });

			            bomGrid.refreshLayout(); // UI ì—…ë°ì´íŠ¸
		       		 })
		        .catch(error => {
		            console.error('ê³µì • ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
		        });
			 }
		
		
		const bomGrid = new Grid({
						el: document.getElementById('bomGrid'),
						rowHeaders: ['checkbox'],
						columns: [
							{header: 'bomë²ˆí˜¸',	name: 'bom_no', width: 100},
							{header: 'ì›ìì¬',	name: 'mtr_name',		editor: 'text', sortable: true, width: 150},
							{header: 'ìì¬ìƒí’ˆ',	name: 'product_name',	editor: 'text', sortable: true, width: 150},
							
							{header: 'ë‹¨ìœ„',		name: 'bom_unit',	
							editor: 'text',
							sortable: true, width: 100},
							
							{header: 'ì†Œëª¨ëŸ‰',	name: 'bom_quantity',	editor: 'text', sortable: true, width: 100},
							{header: 'ë“±ë¡ì¼',	name: 'bom_date',	editor: 'text', sortable: true, width: 150},
							
							{header: 'ê³µì •',		
							name: 'process_name',	
							formatter: ({ value }) => processCodeToName(value), 
		                    editor: {
		                        type: 'checkbox',
		                        options: {
		                            listItems: processOptions
		                        }
		                    }, 
							sortable: true,
							width: 200},
							
							{header: 'ìƒíƒœ',		
							 name: 'bom_status',
							 formatter: ({ value }) => {
							         if (value === 'Y') return 'ì‚¬ìš©';
							         if (value === 'N') return 'ë¯¸ì‚¬ìš©';
							         return 'ì‚¬ìš©'; // ê°’ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ì„ "ì‚¬ìš©"ìœ¼ë¡œ ì„¤ì •
							     },	 	
							 editor: {
				                type: 'select',
				                options: {
				                    listItems: [
				                        { value: 'Y', text: 'ì‚¬ìš©' },  
				                        { value: 'N', text: 'ë¯¸ì‚¬ìš©' }
				                    ]
				                }
				            },
							sortable: true, width: 50}
						],
						data: [],
						columnOptions: {
						  resizable: true
						}
					});
			
					
					
					
					
			function selectUnit() {
			    fetch('/api/product/select/unit')
			        .then(response => response.json())
			        .then(data => {
			            console.log("ì„œë²„ì—ì„œ ë°›ì€ ë‹¨ìœ„ ë°ì´í„°:", data);

			            const unitOptions = data.map(unit => ({
			                text: unit.common_detail_name, // ì˜µì…˜ í‘œì‹œê°’
			                value: unit.common_detail_code // ì‹¤ì œ ì €ì¥ë  ê°’
			            }));

			            console.log("ë‹¨ìœ„ ì˜µì…˜:", unitOptions);
						
						// ê³µí†µì½”ë“œ â†’ ë‹¨ìœ„ëª… ë§¤í•‘ ê°ì²´ ìƒì„±
			          	unitMap = Object.fromEntries(
			              data.map(unit => [unit.common_detail_code, unit.common_detail_name])
			          	);
						console.log("âœ… unitMap:", unitMap);
						
			            // productGridì˜ ë‹¨ìœ„ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
			            productGrid.getColumns().forEach(column => {
			                if (column.name === 'PRODUCT_UNIT' && column.editor) {
			                    column.editor.options.listItems = unitOptions;
			                }
			            });
			            productGrid.refreshLayout();
			         
			        })
			        .catch(error => console.error("ë‹¨ìœ„ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:", error));
				}
			
				
	
			
			//ê³µì •ìœ í˜• ê³µí†µì½”ë“œ -> ì´ë¦„ê°’ìœ¼ë¡œ ë³€ê²½ í›„ ì‰¼í‘œë¡œ êµ¬ë¶„				
			function processCodeToName(value) {
			    if (!value) return '';
				
				// ê°’ì´ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì´ë¼ë©´ ë°°ì—´ë¡œ ë³€í™˜
				   if (typeof value === 'string' && value.includes(',')) {
				       value = value.split(',').map(v => v.trim()); // ë¬¸ìì—´ â†’ ë°°ì—´ ë³€í™˜
				   }
				
				//ê°’ì´ ì—¬ëŸ¬ê°œì¼ë•Œ -> ê³µì •ìœ í˜•ì´ ë°°ì—´ë¡œ ë‹´ê¹€ -> ê³µí†µì½”ë“œë¥¼ ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ê³  ì‰¼í‘œ ë„£ê¸°
				if (Array.isArray(value)) {
				        return value.map(v => {
				            const process = processOptions.find(p => p.value === v);
				            return process ? process.text : v;
				        }).join(', '); // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
				    }
				
			    const process = processOptions.find(p => p.value === value);
			    return process ? process.text : value;  // ì½”ë“œ â†’ ì´ë¦„ ë³€í™˜
			}		
					
		
			
		   //ìƒí’ˆë“±ë¡ ëª¨ë‹¬ì°½ ì—´ê¸°
		   function openProductModal() {
		       const productModal = new bootstrap.Modal(document.getElementById('productModal'));
		       productModal.show();
		   }
		
		  
		  //ìƒí’ˆë“±ë¡ ì…ë ¥ê°’ ë“¤ê³ ì˜¤ê¸°
		  document.getElementById('registBtn').addEventListener('click', function () {
			 const productName = document.getElementById('proName').value;
			 const productUnit = document.getElementById('proUnit').value;
			 const productType = document.getElementById('proType').value;
		     
			 //ë¹ˆì¹¸ê²€ì‚¬
			 if (!productName || !productUnit || !productType) {
		         alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
		         return;
			   }
			   
			 // 2. Ajaxë¡œ ì„œë²„ì— ë°ì´í„° ì „ì†¡
			    $.ajax({
			        url: '/api/product/save',
			        type: 'POST',
			        contentType: 'application/json',
			        data: JSON.stringify({
			            product_name: productName,
			            product_unit: productUnit,
			            product_type: productType
			           
			        }),
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
						},
			        success: function (response) {
						updateProductGrid();// ê·¸ë¦¬ë“œì— ë°ì´í„° ì¶”ê°€
						alert("ì €ì¥ì„±ê³µ");
						$('#productModal').modal('hide'); // ëª¨ë‹¬ ì°½ ë‹«ê¸°
			        },
			        error: function (error) {
			            console.error('ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
			            alert('ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
			        }
			    });
				
				
		  	});
     
		  
			//ìƒí’ˆê·¸ë¦¬ë“œ ì¡°íšŒ
			function updateProductGrid() {
			    const productName = document.getElementById('productName').value || ''; // ìƒí’ˆëª… ì…ë ¥ê°’
			    const searchMonth = document.getElementById('searchMonth').value || ''; // ë“±ë¡ ì›” ì…ë ¥ê°’
				console.log('ìƒí’ˆëª…:', productName); // ë””ë²„ê¹…ìš©
				console.log('ë“±ë¡ì›”:', searchMonth); // ë””ë²„ê¹…ìš©

			    // Ajax ìš”ì²­ìœ¼ë¡œ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
			    $.ajax({
			        url: '/api/product/list',
			        type: 'POST',
					contentType: 'application/json',
			        data: JSON.stringify({ // dataë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
			           productName: productName,
			           searchMonth: searchMonth
			        }),
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
			        success: function (response) {
						console.log('ì‘ë‹µë‹µë‹µë‹µë°ì´í„°:', response); // ì„œë²„ ì‘ë‹µ í™•ì¸
			            // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê·¸ë¦¬ë“œì— ì—…ë°ì´íŠ¸
			            productGrid.resetData(response);
						productGrid.refreshLayout();
			        },
			        error: function (error) {
			            console.error('ê·¸ë¦¬ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
			        }
			    });
			}
			
			document.addEventListener('DOMContentLoaded', function () {
			    updateProductGrid(); // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
			});
		
			
			//bomë“±ë¡ íŒì—…ì°½
			function popUp() {
			 const selectedRows = productGrid.getCheckedRows();
					  
			  if (selectedRows.length === 0) {
			         alert("ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
			         return;
			     }
				 
			  if (selectedRows.length > 1) {
			        alert("í•˜ë‚˜ì˜ ìƒí’ˆë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.");
			        return;
			    }		
				
			  // ì²« ë²ˆì§¸ ì„ íƒëœ í–‰ì˜ ë°ì´í„°ë§Œ ì‚¬ìš©
			  const selectedProduct = selectedRows[0]; 
			  // ìƒí’ˆë²ˆí˜¸ì™€ ìƒí’ˆëª…
		      const productNo = selectedProduct.PRODUCT_NO;
		      const productName = selectedProduct.PRODUCT_NAME;
			  	
	   	      const popupOptions = "width=800,height=600,scrollbars=yes,resizable=yes"; // íŒì—…ì°½ ì˜µì…˜
	   	      const popupUrl = `/bom-info?productNo=${productNo}&productName=${encodeURIComponent(productName)}`; // íŒì—…ì°½ìœ¼ë¡œ ì—´ë¦´ í˜ì´ì§€ URL
	   	      window.open(popupUrl, "assignInsertPopup", popupOptions);
			}	
			
			// **í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰**
			   document.addEventListener('DOMContentLoaded', function () {
			       loadProcessOptions(); // ê³µì • ì˜µì…˜ ë°ì´í„° ë¡œë“œ
			       updateProductGrid();  // ìƒí’ˆ ëª©ë¡ ë¡œë“œ
			       selectUnit(); //ë‹¨ìœ„ ëª©ë¡ ë¡œë“œ
			   });
			
			
			let productNo = null; //ìƒí’ˆë²ˆí˜¸ ì „ì—­ë³€ìˆ˜
			
			//ìƒìœ„ê·¸ë¦¬ë“œ í´ë¦­ ì‹œ í•˜ìœ„ê·¸ë¦¬ë“œ ì¡°íšŒ í•¨ìˆ˜ ì‹¤í–‰
			productGrid.on('click', (event) => {
			    const clickedRow = productGrid.getRow(event.rowKey);
				console.log('í´ë¦­í•œ í–‰ ê°’ :', clickedRow);
			    
				productNo = clickedRow.PRODUCT_NO; // ì „ì—­ë³€ìˆ˜ : í´ë¦­í•œ í–‰ì˜ ìƒí’ˆë²ˆí˜¸ì— ë‹´ê¸°
				console.log('ìƒí’ˆë²ˆí˜¸!!! :', productNo);
				
				//í•˜ìœ„ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
				updateBomGrid(productNo);
			});
			
			//í•˜ìœ„ê·¸ë¦¬ë“œ ì¡°íšŒ í•¨ìˆ˜ ì‹¤í–‰
			function updateBomGrid(productNo){
			 fetch(`/api/product/bom/list?product_no=${productNo}`)
		        .then(response => response.json())
		        .then(data => {
					console.log('ë°ì´í„°ê°’!',data);
		            bomGrid.resetData(data); // í•˜ìœ„ ê·¸ë¦¬ë“œì— ë°ì´í„° ì—…ë°ì´íŠ¸
					bomGrid.refreshLayout();
		        })
		        .catch(error => {
		            console.error('BOM ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
		        });
			}
			
			
			// bomì²´í¬ë°•ìŠ¤ ì‚­ì œ í•¨ìˆ˜ - ì‚­ì œë²„íŠ¼
			function deleteSelectedRows() {
			    let idsToDelete = [];
			    let url = '';
			
			    // ğŸš€ ìƒìœ„ ê·¸ë¦¬ë“œ(ìƒí’ˆ)ì—ì„œ ì²´í¬ëœ í–‰ í™•ì¸
			    const selectedProductRows = productGrid.getCheckedRows();
			    const selectedBomRows = bomGrid.getCheckedRows();
			
			    if (selectedProductRows.length > 0 && selectedBomRows.length === 0) {
			        // ìƒìœ„ ê·¸ë¦¬ë“œ(ìƒí’ˆ)ì—ì„œ ì„ íƒëœ ê²½ìš° (í•˜ìœ„ ê·¸ë¦¬ë“œ ë¯¸ì„ íƒ)
			        idsToDelete = selectedProductRows.map(row => row.PRODUCT_NO);
			        url = '/api/product/delete/row/product'; //  ìƒìœ„ ê·¸ë¦¬ë“œ ì‚­ì œ API
			        
			    } else if (selectedBomRows.length > 0 && selectedProductRows.length === 0) {
			        // í•˜ìœ„ ê·¸ë¦¬ë“œ(BOM)ì—ì„œ ì„ íƒëœ ê²½ìš° (ìƒìœ„ ê·¸ë¦¬ë“œ ë¯¸ì„ íƒ)
			        idsToDelete = selectedBomRows.map(row => row.bom_no);
			        url = '/api/product/delete/row'; // í•˜ìœ„ ê·¸ë¦¬ë“œ ì‚­ì œ API
			        
			    } else if (selectedProductRows.length > 0 && selectedBomRows.length > 0) {
			        // ê·¸ë¦¬ë“œë¥¼ ë‘˜ ë‹¤ ì„ íƒí•œ ê²½ìš° â†’ í•˜ë‚˜ë§Œ ì„ íƒí•˜ë¼ê³  ì•Œë¦¼
			        alert("ìƒí’ˆê³¼ BOMì„ ë™ì‹œì— ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•˜ë‚˜ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.");
			        return;
			        
			    } else {
			        alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
			        return;
			    }
			
			    console.log(" ì‚­ì œ ìš”ì²­ URL:", url);
			    console.log(" ì‚­ì œí•  ID ëª©ë¡:", idsToDelete);
			
			    //ì„œë²„ë¡œ ì‚­ì œ ìš”ì²­ ë³´ë‚´ê¸°
			    fetch(url, {
			        method: 'POST',
			        headers: {
			            'Content-Type': 'application/json',
			            [header]: token // CSRF í† í° ì¶”ê°€
			        },
			        body: JSON.stringify(idsToDelete)
			    })
			    .then(response => {
			        if (!response.ok) {
			            throw new Error(`HTTP error! status: ${response.status}`);
			        }
			        return response.text();
			    })
			    .then(data => {
			        alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
			        if (url === '/api/product/delete/row/product') {
			            //  ìƒìœ„ ê·¸ë¦¬ë“œ ì‚­ì œ í›„, í•˜ìœ„ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
			            updateProductGrid();
			            bomGrid.resetData([]); // ìƒí’ˆ ì‚­ì œ ì‹œ BOMë„ ì´ˆê¸°í™”
			        } else {
			            //  í•˜ìœ„ ê·¸ë¦¬ë“œ ì‚­ì œ í›„, ë‹¤ì‹œ í•˜ìœ„ ê·¸ë¦¬ë“œ ê°±ì‹ 
			            const selectedRow = productGrid.getRow(productGrid.getFocusedCell()?.rowKey);
			            if (selectedRow && selectedRow.PRODUCT_NO) {
			                updateBomGrid(selectedRow.PRODUCT_NO);
			            }
			        }
			    })
			    .catch(error => {
			        console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
			    });
			}


			
			
			//BOMê·¸ë¦¬ë“œ, ìƒí’ˆê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
			function updateBom(){
				const bomData = bomGrid.getData();
				const productData = productGrid.getData();
				
				const product = productData.map(row => ({
				      product_no: row.PRODUCT_NO,
				      product_name: row.PRODUCT_NAME,
				      product_type: row.PRODUCT_TYPE,
				      product_unit: row.PRODUCT_UNIT
				  }));
				
				bomData.forEach(row => {
				      
					  //ê³µì •ì´ë¦„ì„ ê³µì •ë²ˆí˜¸ë¡œ ë³€í™˜ (ì„œë²„ëŠ” process_noë¡œ ì €ì¥í•´ì•¼ í•¨)
					  const process = processOptions.find(p => p.text === row.process_name);
					  row.process_name = process ? process.value : row.process_name; // process_noë¡œ ë³€í™˜
					  console.log('ê³µì •ìœ í˜•ã…—ã…—', row.process_name);	
					  
					  row.bom_no = row.bom_no || null;
				      row.bom_quantity = row.bom_quantity || 0; // ì†Œëª¨ëŸ‰ ê¸°ë³¸ê°’ 0
				      row.bom_status = row.bom_status || 'Y';  // ìƒíƒœ ê¸°ë³¸ê°’ 'Y'
					 
				  });
				  
				  const gridUpdate = {
					bomList: bomData,
					product: product //ì—¬ëŸ¬ê°œì˜ ìƒí’ˆì„ ë°°ì—´ë¡œ ì „ì†¡
				  }
				  
				  fetch('/api/product/update/all', { // ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
				         method: 'POST',
				         headers: {
				             'Content-Type': 'application/json',
				             [header]: token
				         },
				         body: JSON.stringify(gridUpdate)
				     })
				     .then(response => response.text())
				     .then(data => {
				         alert('BOM ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
				         updateBomGrid(productNo); // ì €ì¥ í›„ ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨
				     })
				     .catch(error => {
				         console.error('BOM ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
				     });
				
			}
			
			
		
		
	</script>


</body>

</html>