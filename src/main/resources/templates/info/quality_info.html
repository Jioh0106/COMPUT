<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMPUT.</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/vendors/iconly/bold.css">
    <link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
    <link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="icon" href="images/favicon.png" type="images/png">
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    
    <meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
    <meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />

	<style>
	    .tui-grid-cell {
	        background-color: #ffffff !important;
	    }
	    .display-flex {
	        display: flex;
	    }
	    .buttons {
	        margin-left: auto;
	    }
	    #qcGrid {
	        margin-bottom: 20px;
	        width: 100%;
	        height: 300px;
	    }
	    #defectGrid {
	        margin-bottom: 20px;
	        width: 100%;
	        height: 300px;
	    }
	</style>
</head>

<body>
    <div id="app">
        <!-- 사이드 메뉴바-->
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>

        <!-- 메인 content -->
        <div id="main">
            <div class="display-flex">
                <h3>품질관리 기준</h3>
            </div>

            <div class="card">
                <div class="card-body" id="default">
                    <section class="section">
                        <div class="row" id="basic-table">
                            <form>
                                <!-- 검색 조건 -->
                                <div class="row mb-4">
                                    <!-- 공정구분 -->
                                    <div class="col-md-4">
                                        <label for="processId" class="form-label">공정구분</label>
                                        <select id="processId" class="form-control" onchange="updateGrids()">
                                            <option value="">전체</option>
                                        </select>
                                    </div>
                                    <!-- 검사항목명 -->
                                    <div class="col-md-4">
                                        <label for="searchName" class="form-label">검사항목</label>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                                            <input type="text" class="form-control" id="searchName" 
                                                   placeholder="검사항목명을 입력하세요" onkeyup="updateGrids()">
                                        </div>
                                    </div>
                                </div>

                                <!-- 품질검사 기준 섹션 -->
                                <div class="mb-4">
                                    <div class="float-end mb-3">
                                        <input type="button" class="btn btn-outline-secondary" value="품질검사 등록" 
                                               onclick="openQcModal()">
                                    </div>
                                    <h4>품질검사 기준</h4>
                                    <div id="qcGrid" class="mb-3"></div>
                                </div>

                                <!-- 불량검사 기준 섹션 -->
                                <div class="mb-4">
                                    <div class="float-end mb-3">
                                        <input type="button" class="btn btn-outline-secondary" value="불량유형 등록" 
                                               onclick="openDefectModal()">
                                    </div>
                                    <h4>불량검사 기준</h4>
                                    <div id="defectGrid" class="mb-3"></div>
                                </div>

                                <!-- 버튼 영역 -->
                                <div class="float-end">
                                    <input type="button" class="btn btn-outline-success" value="저장" onclick="saveData()">
                                    <input type="button" class="btn btn-outline-danger" value="삭제" onclick="deleteSelected()">
                                </div>
                            </form>
                        </div>
                    </section>
                </div>
            </div>

            <!-- 품질검사 등록 모달 -->
            <div class="modal fade" id="qcModal" tabindex="-1" aria-hidden="true">
                <!-- 모달 내용 -->
            </div>

            <!-- 불량유형 등록 모달 -->
            <div class="modal fade" id="defectModal" tabindex="-1" aria-hidden="true">
                <!-- 모달 내용 -->
            </div>
        </div>
    </div>
	
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<script th:src="@{/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/js/main.js}"></script>

	<!-- TOAST UI CDN -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.js"></script>
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>

    <!-- Script 영역 -->
	<script th:inline="javascript">
	    const header = document.querySelector('meta[name="_csrf_header"]').content;
	    const token = document.querySelector('meta[name="_csrf"]').content;
	    
	    var Grid = tui.Grid;    // TOAST UI Grid 초기화

	    // 품질검사 그리드
	    const qcGrid = new Grid({
	        el: document.getElementById('qcGrid'),
	        rowHeaders: ['checkbox'],
	        columns: [
	            {header: '검사코드',     name: 'qc_code',           sortable: true},
	            {header: '검사명',      name: 'qc_name',           editor: 'text', sortable: true},
	            {header: '공정',        name: 'process_id',        sortable: true},
	            {header: '목표값',      name: 'target_value',      editor: 'text', sortable: true},
	            {header: '상한값',      name: 'ucl',              editor: 'text', sortable: true},
	            {header: '하한값',      name: 'lcl',              editor: 'text', sortable: true},
	            {header: '단위',        name: 'unit',             editor: 'text', sortable: true},
	            {header: '사용여부',     name: 'use_yn',           editor: 'text', sortable: true}
	        ],
	        data: [],  // 초기 데이터는 비어있음
	        columnOptions: {
	            resizable: true
	        }
	    });

	    // 불량검사 그리드
	    const defectGrid = new Grid({
	        el: document.getElementById('defectGrid'),
	        rowHeaders: ['checkbox'],
	        columns: [
	            {header: '불량코드',     name: 'defect_code',       sortable: true},
	            {header: '불량명',      name: 'defect_name',       editor: 'text', sortable: true},
	            {header: '공정',        name: 'process_id',        sortable: true},
	            {header: '불량유형',     name: 'defect_type',       editor: 'text', sortable: true},
	            {header: '불량수준',     name: 'defect_level',      editor: 'text', sortable: true},
	            {header: '판정기준',     name: 'judgment_criteria', editor: 'text', sortable: true},
	            {header: '사용여부',     name: 'use_yn',           editor: 'text', sortable: true}
	        ],
	        data: [],  // 초기 데이터는 비어있음
	        columnOptions: {
	            resizable: true
	        }
	    });

	    // 페이지 로드 시 그리드 데이터 조회
	    document.addEventListener('DOMContentLoaded', function() {
	        updateGrids();  // 초기 데이터 로드
	    });

	    // 그리드 데이터 조회 함수
	    function updateGrids() {
	        const processId = document.getElementById('processId').value || '';
	        const searchName = document.getElementById('searchName').value || '';

	        // 품질검사 그리드 데이터 조회
	        $.ajax({
	            url: '/api/quality/qc/list',
	            type: 'POST',
	            contentType: 'application/json',
	            data: JSON.stringify({
	                processId: processId,
	                searchName: searchName
	            }),
	            beforeSend: function(xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function(response) {
	                qcGrid.resetData(response);
	            },
	            error: function(error) {
	                console.error('품질검사 데이터 조회 중 오류:', error);
	            }
	        });

	        // 불량검사 그리드 데이터 조회
	        $.ajax({
	            url: '/api/quality/defect/list',
	            type: 'POST',
	            contentType: 'application/json',
	            data: JSON.stringify({
	                processId: processId,
	                searchName: searchName
	            }),
	            beforeSend: function(xhr) {
	                xhr.setRequestHeader(header, token);
	            },
	            success: function(response) {
	                defectGrid.resetData(response);
	            },
	            error: function(error) {
	                console.error('불량검사 데이터 조회 중 오류:', error);
	            }
	        });
	    }

	    // 그리드 높이 설정
	    qcGrid.setHeight(300);
	    defectGrid.setHeight(300);

	    // 품질검사 등록 모달
	    function openQcModal() {
	        const qcModal = new bootstrap.Modal(document.getElementById('qcModal'));
	        qcModal.show();
	    }

	    // 불량검사 등록 모달
	    function openDefectModal() {
	        const defectModal = new bootstrap.Modal(document.getElementById('defectModal'));
	        defectModal.show();
	    }

	    // 데이터 저장
	    function saveData() {
	        const qcModifiedRows = qcGrid.getModifiedRows();
	        const defectModifiedRows = defectGrid.getModifiedRows();

	        // 수정된 데이터가 있는지 확인
	        if (!hasModifiedData(qcModifiedRows) && !hasModifiedData(defectModifiedRows)) {
	            alert('저장할 데이터가 없습니다.');
	            return;
	        }

	        // 데이터 저장 로직 구현
	    }

	    // 선택된 행 삭제
	    function deleteSelected() {
	        const selectedQcRows = qcGrid.getCheckedRows();
	        const selectedDefectRows = defectGrid.getCheckedRows();

	        if (selectedQcRows.length === 0 && selectedDefectRows.length === 0) {
	            alert('삭제할 행을 선택해주세요.');
	            return;
	        }

	        if (!confirm('선택한 항목을 삭제하시겠습니까?')) {
	            return;
	        }

	        // 삭제 로직 구현
	    }

	    // 수정된 데이터 존재 여부 확인
	    function hasModifiedData(modifiedRows) {
	        return modifiedRows.createdRows.length > 0 
	            || modifiedRows.updatedRows.length > 0 
	            || modifiedRows.deletedRows.length > 0;
	    }
	</script>
</body>
</html>