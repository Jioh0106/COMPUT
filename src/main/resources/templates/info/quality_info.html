<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>COMPUT.</title>

   <link rel="preconnect" href="https://fonts.gstatic.com">
   <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="assets/css/bootstrap.css">
   <link rel="stylesheet" href="assets/vendors/iconly/bold.css">
   <link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
   <link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
   <link rel="stylesheet" href="assets/css/app.css">
   <link rel="icon" href="images/favicon.png" type="images/png">
   <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
   
   <meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
   <meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />

   <style>
       .tui-grid-cell {
           background-color: #ffffff !important;
       }
       .display-flex {
           display: flex;
       }
       .buttons {
           margin-left: auto;
       }
       #qcGrid, #defectGrid {
           margin-bottom: 20px;
           width: 100%;
           height: 300px;
       }
       .mb-4 {
           margin-bottom: 1.5rem !important;
       }
       .required::after {
           content: " *";
           color: red;
       }
       .form-label {
           margin-bottom: 0.5rem;
           font-weight: 600;
       }
       .grid-section {
        min-height: 300px;
        }
   </style>
</head>

<body>
   <div id="app">
       <!-- 사이드 메뉴바-->
       <div th:replace="~{fragments/sidebar :: sidebar}"></div>

       <!-- 메인 content -->
       <div id="main">
           <div class="display-flex">
               <h3>품질관리 기준</h3>
           </div>

           <div class="card">
               <div class="card-body">
                   <section class="section">
                       <div class="row" id="basic-table">
                           <form>
                               <div class="row mb-4">
                                   <div class="col-md-4">
                                       <label for="processNo" class="form-label">공정구분</label>
                                       <select id="processNo" class="form-control" onchange="updateGrids()">
                                           <option value="">전체</option>
                                       </select>
                                   </div>
                                   <div class="col-md-4">
                                       <label for="searchName" class="form-label">검사항목</label>
                                       <div class="input-group mb-3">
                                           <span class="input-group-text"><i class="bi bi-search"></i></span>
                                           <input type="text" class="form-control" id="searchName" 
                                                  placeholder="검사항목명을 입력하세요" onkeyup="updateGrids()">
                                       </div>
                                   </div>
                               </div>
								<ul class="nav nav-tabs" id="qualityTab" role="tablist">
					            <li class="nav-item" role="presentation">
					                <button class="nav-link active" id="qc-tab" data-bs-toggle="tab" data-bs-target="#qc" type="button" role="tab" aria-controls="qc" aria-selected="true">품질검사 기준</button>
					            </li>
					            <li class="nav-item" role="presentation">
					                <button class="nav-link" id="defect-tab" data-bs-toggle="tab" data-bs-target="#defect" type="button" role="tab" aria-controls="defect" aria-selected="false">불량검사 기준</button>
					            </li>
					        </ul>
					        <div class="tab-content mt-3" id="qualityTabContent">
					            <div class="tab-pane fade show active" id="qc" role="tabpanel" aria-labelledby="qc-tab">
					                <!-- 품질검사 기준 섹션 -->
					                <div id="qcSection">
					                    <div id="qcGrid"></div>
					                </div>
					            </div>
					            <div class="tab-pane fade" id="defect" role="tabpanel" aria-labelledby="defect-tab">
					                <!-- 불량검사 기준 섹션 -->
					                <div id="defectSection">
					                    <div id="defectGrid"></div>
					                </div>
					            </div>
       						</div>
                               <!-- 버튼 영역 -->
								<div class="float-end">
									<input type="button" class="btn btn-outline-secondary" id="" value="등록" onclick="popUp()">
									<input type="button" class="btn btn-outline-success" id="save"  value="저장" onclick="saveData()">
									<input type="button" class="btn btn-outline-danger" id="del" value="삭제" onclick="deleteSelectedRows()">
								</div>
                           </form>
                       </div>
                   </section>
               </div>
           </div>

           <!-- 품질검사 등록 모달 -->
           <div class="modal fade" id="qcModal" tabindex="-1" aria-hidden="true">
               <div class="modal-dialog modal-dialog-centered">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">품질검사 기준 등록</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                       </div>
                       <div class="modal-body">
                           <form id="qcForm">
                               <div class="form-group mb-3">
                                   <label for="qc_name" class="form-label required">검사명</label>
                                   <input type="text" class="form-control" id="qc_name" required>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="qc_process" class="form-label required">공정</label>
                                   <select class="form-control" id="qc_process" required>
                                   </select>
                               </div>
                               <div class="row">
                                   <div class="col-md-4">
                                       <div class="form-group mb-3">
                                           <label for="target_value" class="form-label">목표값</label>
                                           <input type="number" class="form-control" id="target_value" step="0.01">
                                       </div>
                                   </div>
                                   <div class="col-md-4">
                                       <div class="form-group mb-3">
                                           <label for="ucl" class="form-label">상한값</label>
                                           <input type="number" class="form-control" id="ucl" step="0.01">
                                       </div>
                                   </div>
                                   <div class="col-md-4">
                                       <div class="form-group mb-3">
                                           <label for="lcl" class="form-label">하한값</label>
                                           <input type="number" class="form-control" id="lcl" step="0.01">
                                       </div>
                                   </div>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="qc_unit" class="form-label required">단위</label>
                                   <select class="form-control" id="qc_unit" required>
                                   </select>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="qc_method" class="form-label">검사방법</label>
                                   <textarea class="form-control" id="qc_method" rows="3"></textarea>
                               </div>
                           </form>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                           <button type="button" class="btn btn-primary" onclick="saveQcData()">저장</button>
                       </div>
                   </div>
               </div>
           </div>

           <!-- 불량유형 등록 모달 -->
           <div class="modal fade" id="defectModal" tabindex="-1" aria-hidden="true">
               <div class="modal-dialog modal-dialog-centered">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">불량유형 기준 등록</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                       </div>
                       <div class="modal-body">
                           <form id="defectForm">
                               <div class="form-group mb-3">
                                   <label for="defect_name" class="form-label required">불량명</label>
                                   <input type="text" class="form-control" id="defect_name" required>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="defect_process" class="form-label required">공정</label>
                                   <select class="form-control" id="defect_process" required>
                                   </select>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="defect_type" class="form-label required">불량유형</label>
                                   <select class="form-control" id="defect_type" required>
                                   </select>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="defect_level" class="form-label required">불량수준</label>
                                   <select class="form-control" id="defect_level" required>
                                   </select>
                               </div>
                               <div class="form-group mb-3">
                                   <label for="judgment_criteria" class="form-label">판정기준</label>
                                   <textarea class="form-control" id="judgment_criteria" rows="3"></textarea>
                               </div>
                           </form>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                           <button type="button" class="btn btn-primary" onclick="saveDefectData()">저장</button>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- 스크립트 -->
   <script th:src="@{/js/jquery-3.7.1.js}"></script>
   <script th:src="@{/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js}"></script>
   <script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
   <script th:src="@{/assets/js/main.js}"></script>
   <script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.js"></script>

   <script th:inline="javascript">
       const header = document.querySelector('meta[name="_csrf_header"]').content;
       const token = document.querySelector('meta[name="_csrf"]').content;
       
       var Grid = tui.Grid;    // TOAST UI Grid 초기화

    // 품질검사 그리드
       const qcGrid = new Grid({
           el: document.getElementById('qcGrid'),
           rowHeaders: ['checkbox'],
           columns: [
               {header: '검사코드', name: 'qcCode'},
               {header: '검사명', name: 'qcName'},
               {header: '공정번호', name: 'processNo'},
               {header: '제품번호', name: 'productNo'},
               {header: '목표값', name: 'targetValue'},
               {header: '상한값', name: 'ucl'},
               {header: '하한값', name: 'lcl'},
               {header: '단위', name: 'unit'},
               {header: '검사방법', name: 'qcMethod'},
               {header: '사용여부', name: 'useYn'}
           ],
           data: [],
           columnOptions: {
			  resizable: true
		  }
       });

       // 불량검사 그리드
       const defectGrid = new Grid({
           el: document.getElementById('defectGrid'),
           rowHeaders: ['checkbox'],
           columns: [
               {header: '불량코드', name: 'defectCode'},
               {header: '불량명', name: 'defectName'},
               {header: '공정번호', name: 'processNo'},
               {header: '불량유형', name: 'defectType'},
               {header: '불량수준', name: 'defectLevel'},
               {header: '판정기준', name: 'judgmentCriteria'},
               {header: '사용여부', name: 'useYn'}
           ],
           data: [],
           columnOptions: {
			  resizable: true
			}
       });

//        // 공통코드 조회 함수
//        function loadCommonCodes() {
//            // 공정 목록 조회
//            $.ajax({
//                url: '/api/process/list',
//                type: 'GET',
//                success: function(response) {
//                    const processes = response;
//                    const processOptions = processes.map(p => 
//                        `<option value="${p.process_no}">${p.process_name}</option>`
//                    ).join('');
//                    $('#processNo, #qc_process, #defect_process').html('<option value="">선택</option>' + processOptions);
//                }
//            });

//            // 단위 코드 조회
//            $.ajax({
//                url: '/api/common/codes/UNIT',
//                type: 'GET',
//                success: function(response) {
//                    const units = response;
//                    const unitOptions = units.map(u => 
//                        `<option value="${u.code}">${u.code_name}</option>`
//                    ).join('');
//                    $('#qc_unit').html('<option value="">선택</option>' + unitOptions);
//                }
//            });

//            // 불량유형 코드 조회
//            $.ajax({
//                url: '/api/common/codes/DFTP',
//                type: 'GET',
//                success: function(response) {
//                    const types = response;
//                    const typeOptions = types.map(t => 
//                        `<option value="${t.code}">${t.code_name}</option>`
//                    ).join('');
//                    $('#defect_type').html('<option value="">선택</option>' + typeOptions);
//                }
//            });

//            // 불량수준 코드 조회
//            $.ajax({
//                url: '/api/common/codes/DFLV',
//                type: 'GET',
//                success: function(response) {
//                    const levels = response;
//                    const levelOptions = levels.map(l => 
//                        `<option value="${l.code}">${l.code_name}</option>`
//                    ).join('');
//                    $('#defect_level').html('<option value="">선택</option>' + levelOptions);
//                }
//            });
//        }

       // 데이터 조회 함수
		function loadGridData() {
		    // 품질검사 데이터 조회
		    $.ajax({
		        url: '/api/quality/qc/list',
		        type: 'GET',
		        success: function(response) {
		            console.log('QC Data:', response);  // 응답 데이터 확인
		            qcGrid.resetData(response);
		        },
		        error: function(xhr, status, error) {
		            console.error('QC Error:', error);  // 에러 확인
		        }
		    });
		
		    // 불량검사 데이터 조회
		    $.ajax({
		        url: '/api/quality/defect/list',
		        type: 'GET',
		        success: function(response) {
		            console.log('Defect Data:', response);  // 응답 데이터 확인
		            defectGrid.resetData(response);
		        },
		        error: function(xhr, status, error) {
		            console.error('Defect Error:', error);  // 에러 확인
		        }
		    });
		}
		
		// 페이지 로드 시 데이터 조회
		document.addEventListener('DOMContentLoaded', function() {
		    loadGridData();
		});
		
		// 탭 변경 시 데이터 로드 함수
		function loadTabData(tab) {
		    if (tab === 'qc') {
		        // 품질검사 데이터 조회
		        $.ajax({
		            url: '/api/quality/qc/list',
		            type: 'GET',
		            success: function(response) {
		                qcGrid.resetData(response);
		            },
		            error: function(xhr, status, error) {
		                console.error('QC Error:', error);
		            }
		        });
		    } else if (tab === 'defect') {
		        // 불량검사 데이터 조회 
		        $.ajax({
		            url: '/api/quality/defect/list',
		            type: 'GET',
		            success: function(response) {
		                defectGrid.resetData(response);
		            },
		            error: function(xhr, status, error) {
		                console.error('Defect Error:', error);
		            }
		        });
		    }
		}
		
		// 탭 콘텐츠 숨김 함수
		function hideTabContent(tab) {
		    if (tab === 'qc') {
		        $('#defectSection').hide();
		    } else if (tab === 'defect') {
		        $('#qcSection').hide();  
		    }
		}

		// 탭 콘텐츠 표시 함수 
		function showTabContent(tab) {
		    if (tab === 'qc') {
		        $('#qcSection').show();
		    } else if (tab === 'defect') {
		        $('#defectSection').show();
		    }
		}
		
		// 탭 변경 이벤트 리스너 등록
		$('#qualityTab button').on('shown.bs.tab', function (event) {
		    const currentTab = $(event.target).data('bs-target').slice(1);
		    const previousTab = $(event.relatedTarget).data('bs-target').slice(1);
		
		    hideTabContent(previousTab);
		    showTabContent(currentTab);
		    loadTabData(currentTab);
		
		    $('#' + currentTab + 'Section').css('visibility', 'hidden');
		
		    requestAnimationFrame(() => {
		        qcGrid.refreshLayout();
		        defectGrid.refreshLayout();
		        $('#' + currentTab + 'Section').css('visibility', 'visible');
		    });
		});


		// 초기 탭 데이터 로드
		$(document).ready(function() {
			$('#defectSection').hide();
		    loadTabData('qc');
		});
		
		function adjustTabContentHeight() {
		    const tabContent = $('#qualityTabContent');
		    const activeTab = tabContent.find('.tab-pane.active');
		    const gridHeight = activeTab.find('.tui-grid-container').outerHeight();
		    
		    tabContent.css('height', gridHeight + 'px');
		}

		// 탭 변경 이벤트 리스너 등록
		$('#qualityTab button').on('shown.bs.tab', function (event) {
		    const currentTab = $(event.target).data('bs-target').slice(1);
		    const previousTab = $(event.relatedTarget).data('bs-target').slice(1);
		    
		    hideTabContent(previousTab);
		    showTabContent(currentTab);
		    loadTabData(currentTab);
		    
		    // 탭 콘텐츠 높이 조정
		    setTimeout(adjustTabContentHeight, 0);
		});

		// 그리드 데이터 로드 후 높이 조정
		function onGridAfterRender() {
		    adjustTabContentHeight();
		}

		qcGrid.on('afterRender', onGridAfterRender);
		defectGrid.on('afterRender', onGridAfterRender);
   </script>
</body>
</html>