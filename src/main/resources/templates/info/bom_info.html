<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COMPUT.</title>

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/bootstrap.css">
	
	<link rel="stylesheet" href="assets/vendors/iconly/bold.css">
	
	<link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
	<link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
	<link rel="stylesheet" href="assets/css/app.css">
	<link rel="icon" href="images/favicon.png" type="images/png">
	
	<!-- TOAST UI CDN -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	
	<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
	<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />

<style>
.tui-grid-cell {
	/* !important -> ìš°ì„ ìˆœìœ„ ë†’ì•„ì§ */
	background-color: #ffffff !important;
}

.display-flex {
	display: flex;
}

.buttons {
	/* í˜ì´ì§€ëª…ê³¼ ê°™ì€ ìœ„ì¹˜ì—ì„œ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ì— ë‘ê¸° ìœ„í•¨ */
	margin-left: auto
}

.buySelect {
	width: 150px !important;
}

.row mb-4{
	display: flex; 
	align-items: center
}

.buyDiv{
	display: flex; 
	align-items: center; 
	max-width: 230px; 
	flex-shrink: 0
}

.nameDiv{
	display: flex; 
	align-items: center; 
	max-width: 400px; 
	flex-shrink: 0;
}



</style>

</head>

<body>

	<div id="app">

		<!-- ë©”ì¸ content -->
		<div id="main">

			<div class="display-flex">
				<h3>BOM ë“±ë¡</h3>
			</div>
			<!-- display-flex -->

			<div class="card">
				<div class="card-body" id="default">
					
					<!-- ê·¸ë¦¬ë“œ ì‹œì‘ -->
					<section class="section">
						<div class="row" id="basic-table">
							<form>
							<div class="row">
								<div class="col-md-6 col-12">
									<div class="form-group">
										<label for="first-name-column">ìƒí’ˆë²ˆí˜¸</label>
										<input type="text" name="product_no" id="proNo" class="form-control" 
										th:value="${productNo}" readonly>
									</div>
								</div>
								
								<div class="col-md-6 col-12">
									<div class="form-group">
										<label for="first-name-column">ìƒí’ˆëª…</label>
										<input type="text" id="proName" name="product_name" 
										th:value="${productName}" class="form-control" 
										readonly>
									</div>
								</div>
							</div>
							
							<!-- ê²€ìƒ‰ ì¡°ê±´ ì‹œì‘ -->
							<div class="row mb-4">
							    <!-- ìì¬/ìƒí’ˆëª… ê²€ìƒ‰ -->
								<div class="col-md-6">
									<label for="nameSearch" class="form-label">ìì¬/ìƒí’ˆëª…</label>
									<div class="input-group mb-3">
										<span class="input-group-text" id="basic-addon1"><i class="bi bi-search"></i></span>
										<input type="text" class="form-control" id="searchInput" placeholder="ìì¬ ë˜ëŠ” ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." aria-label="Recipient's username"
											aria-describedby="button-addon2" onkeyup="searchMtrProduct()">
									</div>
								</div>
							</div>
							<!-- ê²€ìƒ‰ ì¡°ê±´ ë-->	
								
								<!--ìì¬/ìƒí’ˆ ê·¸ë¦¬ë“œ-->										   
								<div id="materialGrid" class="mb-3 mt-2"></div>
								
								<!-- ë²„íŠ¼ ì‹œì‘ -->
								<!--<div sec:authorize="hasRole('ATHR001') or hasRole('ATHR002')">-->
									<div class="float-end">
										<input type="button" class="btn btn-outline-success" id="save"  value="ë“±ë¡" onclick=" popupRegistBtn()">
										<input type="button" class="btn btn-outline-danger" id="del" value="ì·¨ì†Œ">
									</div>
								<!--</div>-->
								<!-- ë²„íŠ¼ ë -->
								
							</form>
						</div>
					</section>
					<!-- ê·¸ë¦¬ë“œ ë  -->

				</div> <!-- card-body -->
			</div> <!-- card -->
		</div> <!-- main -->
	</div> <!-- app -->

	<!-- ì œì´ì¿¼ë¦¬ -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<script th:src="@{/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/js/main.js}"></script>

	<!-- TOAST UI CDN -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.js"></script>
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	
	<script th:inline="javascript">

			const header = document.querySelector('meta[name="_csrf_header"]').content;
			const token = document.querySelector('meta[name="_csrf"]').content;

			
			var Grid = tui.Grid;

			
			
			const materialGrid = new Grid({
				el: document.getElementById('materialGrid'),
				rowHeaders: ['checkbox'],
				columns: [
					{header: 'ìì¬/ìƒí’ˆë²ˆí˜¸', name: 'ITEM_NO', hidden: true},
					{header: 'ìì¬êµ¬ë¶„',	   name: 'ITEM_TYPE', editor: 'text', sortable: true},
					{header: 'ìì¬/ìƒí’ˆëª…',   name: 'ITEM_NAME', editor: 'text', sortable: true},
					{header: 'ë‹¨ìœ„',		   name: 'ITEM_UNIT', editor: 'text', sortable: true}
					
				],
				data: [],
				columnOptions: {
				  resizable: true
				}
			});
			
			
			//ìì¬,ë°˜ì œí’ˆëª… ê²€ìƒ‰
			function searchMtrProduct() {
			  const searchValue = document.getElementById('searchInput').value;

	          // Ajax ìš”ì²­
	          fetch(`/api/product/mtrlist?item_name=${encodeURIComponent(searchValue)}`)
	              .then(response => response.json())
	              .then(data => {
					  console.log('ë°ì´í„°:', data);
	                  materialGrid.resetData(data); // ê·¸ë¦¬ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
	              })
	              .catch(error => console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
			}
	
			
			// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
		      document.addEventListener('DOMContentLoaded', () => {
		           searchMtrProduct(); // ì´ˆê¸° ë°ì´í„° ì¡°íšŒ
		    });
			
			
			//íŒì—…ì°½ì—ì„œ bomë“±ë¡ (íŒì—…ì°½ ë“±ë¡ë²„íŠ¼)
			function popupRegistBtn() {
			 const selectedRow = materialGrid.getCheckedRows();
				selectedRow.forEach(row => {
				    console.log('ì²´í¬ëœ í–‰ì˜ ìì¬/ìƒí’ˆpk:', row.ITEM_NO); // ê° í–‰ì˜ ITEM_NAME ì¶œë ¥
				 });
			
			 //ëª©ì ìƒí’ˆë²ˆí˜¸
		  	 const product_no = /*[[${productNo}]]*/ 'UNKNOWN';
		   	 console.log('ëª©ì ìƒí’ˆ', product_no);
			
			 //ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒí•œ í–‰ë“¤.
			 const itemSelect = selectedRow.map(row => ({
				itemType: row.ITEM_TYPE,
				itemNo: row.ITEM_NO,
				itemUnit: row.ITEM_UNIT,
				productNo: product_no
				}));
			 console.log("itemSelect ê°’:", itemSelect);
			
			 fetch('/api/product/bom/insert',{
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					 [header]: token // CSRF í† í° ì¶”ê°€
				},
				body: JSON.stringify(itemSelect)	
			 })
			 .then(response => response.text()) //ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ Stringìœ¼ë¡œ ì‘ë‹µì„ ë°›ê³ ìˆìŒ. json()->text()ë¡œ ë°”ê¿”ì¤˜ì•¼í•¨.
			 .then(data => {
			    console.log('ì„œë²„ì‘ë‹µ:', data);
				alert(data);
				
				//window.opener.location.reload(); // ë¶€ëª¨ì°½ ë¦¬ë¡œë“œ
						 // ğŸ”¹ ë¶€ëª¨ ì°½ì˜ `updateBomGrid(productNo)` í•¨ìˆ˜ ì‹¤í–‰ (í•˜ìœ„ ê·¸ë¦¬ë“œë§Œ ì—…ë°ì´íŠ¸)
		        if (window.opener && typeof window.opener.updateBomGrid === "function") {
		            window.opener.updateBomGrid(product_no);
		        }
				
				window.close(); // íŒì—…ì°½ ë‹«ê¸°
			 })
			 .catch(error => {
			    console.error('ì—ëŸ¬ë°œìƒ:', error);
				alert("ë“±ë¡ì‹¤íŒ¨" + error.message);
			 });
	  		}	
		
		
		
		
		
		
		
		
		
		
	</script>


</body>

</html>