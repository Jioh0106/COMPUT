<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.deepen.mapper.SalaryFormulaMapper">
    <!-- 현재 적용중인 급여 공식 목록 조회 -->
    <select id="getCurrentFormulas" resultType="com.deepen.domain.SalaryFormulaDTO">
        SELECT 
            formula_id,
            formula_name,
            formula_type,
            formula_content,
            apply_year,
            formula_priority,
            updated_at,
            formula_code
        FROM 
            SALARY_FORMULA
        WHERE 
            apply_year = #{year}
        ORDER BY 
            formula_priority ASC
    </select>
    
    <!-- 특정 코드의 급여 공식 조회 -->
    <select id="getFormulaByCodeForPayInfo" resultType="com.deepen.domain.SalaryFormulaDTO">
        SELECT 
            formula_id,
            formula_name,
            formula_type,
            formula_content,
            apply_year,
            formula_priority,
            updated_at,
            formula_code
        FROM 
            SALARY_FORMULA
        WHERE 
            formula_code = #{code}
            AND apply_year = #{year}
    </select>
    
    <!-- 급여 지급 이력 리스트 조회 쿼리 -->
    <select id="getAllPayInfo" resultType="com.deepen.domain.PayInfoDTO">
    SELECT
        p.payment_no as paymentNo,
        p.emp_id as empId, 
        e.emp_name as empName,
        cd.common_detail_name as departmentName,
        pos_cd.common_detail_name as positionName,
        e.emp_salary as empSalary,
        p.allow_amt as allowAmt,
        p.deduc_amt as deducAmt, 
        p.net_salary as netSalary,
        p.payment_date as paymentDate,
        p.created_at as createAt,
        p.created_by as createBy,
        p.tech_allowance as techAllowance,
        p.performance_bonus as performanceBonus,
        p.tenure_allowance as tenureAllowance,
        p.holiday_allowance as holidayAllowance,
        p.leave_allowance as leaveAllowance,
        p.national_pension as nationalPension,
        p.health_insurance as healthInsurance,
        p.longterm_care_insurance as longtermCareInsurance,
        p.employment_insurance as employmentInsurance,
        p.income_tax as incomeTax,
        p.resident_tax as residentTax
    FROM payment p
    JOIN employees e ON p.emp_id = e.emp_id
    JOIN common_detail cd ON e.emp_dept = cd.common_detail_code
    JOIN common_detail pos_cd ON e.emp_position = pos_cd.common_detail_code  
    ORDER BY p.create_at DESC
	</select>
    
    <!-- 검색 조건에 따른 급여 내역 조회 쿼리 -->
    <select id="searchPayInfo" resultType="com.deepen.domain.PayInfoDTO">
        SELECT 
            p.payment_no as paymentNo,
            p.emp_id as empId,
            e.emp_name as empName, 
            cd.common_detail_name as departmentName,
            pos_cd.common_detail_name as positionName,
            e.emp_salary as empSalary,
            p.allow_amt as allowAmt,
            p.deduc_amt as deducAmt,
            p.net_salary as netSalary,  
            p.payment_date as paymentDate,
            p.created_at as createAt,  
            p.created_by as createBy
        FROM payment p
        JOIN employees e ON p.emp_id = e.emp_id  
        JOIN common_detail cd ON e.emp_dept = cd.common_detail_code
        JOIN common_detail pos_cd ON e.emp_position = pos_cd.common_detail_code
        <where>
            <if test="department != null and department != ''">
                cd.common_detail_code = #{department}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (e.emp_name LIKE '%${keyword}%' OR p.emp_id LIKE '%${keyword}%')
            </if>  
        </where>
        ORDER BY p.create_at DESC, p.payment_no DESC
    </select>
    
    <insert id="insertPayment" parameterType="com.deepen.domain.PayInfoDTO">
    INSERT INTO payment (
        payment_no, emp_id, payment_date, allow_amt, deduc_amt, net_salary, created_at, created_by
    ) VALUES (
        #{paymentNo}, #{empId}, #{paymentDate}, #{allowAmt}, #{deducAmt}, #{netSalary}, NOW(), #{createdBy}
    )
</insert>

</mapper>